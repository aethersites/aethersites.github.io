<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GoodPlates â€” Onboarding</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* visuals */
    .btn-gradient { color:#fff; background: linear-gradient(90deg,#17A34B,#12B981); }
    .soft-gradient { background: linear-gradient(135deg,#F3F4F6,#FFFFFF 40%,#F3F4F6); }
    .card { background:#fff; border:1px solid #E5E7EB; border-radius:1rem; box-shadow:0 1px 3px rgba(0,0,0,0.04); }
    .card-hover { transition: transform .12s, box-shadow .12s; }
    .card-hover:hover { transform: translateY(-2px); box-shadow:0 8px 24px rgba(0,0,0,0.06); }

    /* chips */
    .chip {
      display:inline-flex; align-items:center; gap:0.5rem; padding:0.5rem 1rem; border-radius:9999px;
      border:1px solid #E5E7EB; font-size:0.875rem; cursor:pointer; user-select:none; background:#fff; color:#111827;
      transition: transform .12s, box-shadow .12s, background-color .12s, color .12s;
      outline:none;
    }
    .chip:hover { transform: translateY(-3px) scale(1.02); box-shadow:0 6px 18px rgba(2,6,23,0.08); background:#21cc93; }
    .chip:focus { box-shadow:0 0 0 4px rgba(16,185,129,0.12); }
    .chip-selected { background:#12B981; color:#fff; border-color:transparent; box-shadow: inset 0 -2px 0 rgba(0,0,0,0.06); }

    /* allergies grid */
    #allergiesContainer { display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:12px; }
    @media (min-width:640px){ #allergiesContainer { grid-template-columns:repeat(3,minmax(0,1fr)); } }
    @media (min-width:768px){ #allergiesContainer { grid-template-columns:repeat(4,minmax(0,1fr)); } }

    /* Progress bar gradient animation */
    .progress-track { width:100%; height:0.5rem; background:#E5E7EB; border-radius:9999px; overflow:hidden; }
    .progress-fill {
      height:100%;
      width:0%;
      border-radius:9999px;
      /* animated gradient background */
      background: linear-gradient(90deg, rgba(23,163,75,0.95) 0%, rgba(18,185,129,0.95) 25%, rgba(16,185,129,0.95) 50%, rgba(18,185,129,0.95) 75%, rgba(23,163,75,0.95) 100%);
      background-size: 200% 100%;
      animation: moveGradient 3s linear infinite;
      transition: width 360ms cubic-bezier(.2,.9,.2,1);
    }
    @keyframes moveGradient {
      0% { background-position: 0% 50%; }
      100% { background-position: 200% 50%; }
    }

    /* small helper disabled style */
    button:disabled { opacity:0.55; cursor:not-allowed; }
  </style>
</head>
<body class="antialiased">
  <main class="soft-gradient min-h-screen">
    <div class="max-w-4xl mx-auto px-6 py-12">
      <!-- Header -->
      <div class="text-center mb-8">
        <h1 class="text-3xl font-bold mb-2">Welcome to GoodPlates</h1>
        <p class="text-gray-600">Let's personalize your experience in just 3 simple steps</p>
      </div>

      <!-- Progress -->
      <div class="mb-6">
        <div class="flex justify-between text-sm text-gray-500 mb-2">
          <span id="progressLabel">Step 1 of 3</span>
          <span id="progressPct">33% Complete</span>
        </div>
        <div class="progress-track mb-2">
          <!-- single progress fill element -->
          <div id="progressBar" class="progress-fill" style="width:33%"></div>
        </div>
      </div>

      <!-- Step Containers -->
      <section id="step-1" class="card p-8 mb-8">
        <h2 class="text-2xl font-semibold text-center mb-2">What do you want to do with groceries?</h2>
        <p class="text-gray-600 text-center mb-8">Choose one or more goals to help us customize your experience</p>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          <button data-goal="grocery-list" class="card card-hover p-6 text-center group" aria-pressed="false" type="button">
            <div class="w-12 h-12 rounded-full bg-gray-200 grid place-items-center mx-auto mb-4 text-white text-xl">ðŸ›’</div>
            <h3 class="font-semibold mb-1">Make Grocery List</h3>
            <p class="text-sm text-gray-600">Create organized shopping lists</p>
          </button>

          <button data-goal="family-plan" class="card card-hover p-6 text-center group" aria-pressed="false" type="button">
            <div class="w-12 h-12 rounded-full bg-gray-200 grid place-items-center mx-auto mb-4 text-white text-xl">ðŸ‘¥</div>
            <h3 class="font-semibold mb-1">Grocery Family Plan</h3>
            <p class="text-sm text-gray-600">Plan meals for the whole family</p>
          </button>

          <button data-goal="in-app-order" class="card card-hover p-6 text-center group" aria-pressed="false" type="button">
            <div class="w-12 h-12 rounded-full bg-gray-200 grid place-items-center mx-auto mb-4 text-white text-xl">ðŸ“±</div>
            <h3 class="font-semibold mb-1">Order Using In-App Capabilities</h3>
            <p class="text-sm text-gray-600">Shop directly through the app</p>
          </button>

          <button data-goal="budget-track" class="card card-hover p-6 text-center group" aria-pressed="false" type="button">
            <div class="w-12 h-12 rounded-full bg-gray-200 grid place-items-center mx-auto mb-4 text-white text-xl">ðŸ’µ</div>
            <h3 class="font-semibold mb-1">Track Grocery Budget</h3>
            <p class="text-sm text-gray-600">Monitor spending and save money</p>
          </button>

          <button data-goal="calorie-goals" class="card card-hover p-6 text-center group" aria-pressed="false" type="button">
            <div class="w-12 h-12 rounded-full bg-gray-200 grid place-items-center mx-auto mb-4 text-white text-xl">ðŸŽ¯</div>
            <h3 class="font-semibold mb-1">Set Calories Goals</h3>
            <p class="text-sm text-gray-600">Reach your nutrition targets</p>
          </button>

          <button data-goal="health-calc" class="card card-hover p-6 text-center group" aria-pressed="false" type="button">
            <div class="w-12 h-12 rounded-full bg-gray-200 grid place-items-center mx-auto mb-4 text-white text-xl">ðŸ“ˆ</div>
            <h3 class="font-semibold mb-1">Calculate Health</h3>
            <p class="text-sm text-gray-600">Track nutrients and wellness</p>
          </button>
        </div>
      </section>

      <!-- Step 2 -->
      <section id="step-2" class="card p-8 mb-8 hidden">
        <h2 class="text-2xl font-semibold text-center mb-2">Nutrition & Preferences</h2>
        <p class="text-gray-600 text-center mb-6">Quick selects â€” pick the items that apply</p>

        <div class="max-w-3xl mx-auto space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Food allergies (tap to select)</label>
            <div id="allergiesContainer" style="gap:12px;">
              <button class="chip" data-value="peanuts" type="button">Peanuts</button>
              <button class="chip" data-value="tree_nuts" type="button">Tree nuts</button>
              <button class="chip" data-value="dairy" type="button">Dairy / Milk</button>
              <button class="chip" data-value="eggs" type="button">Eggs</button>
              <button class="chip" data-value="shellfish" type="button">Shellfish</button>
              <button class="chip" data-value="fish" type="button">Fish</button>
              <button class="chip" data-value="soy" type="button">Soy</button>
              <button class="chip" data-value="wheat_gluten" type="button">Wheat / Gluten</button>
              <button class="chip" data-value="sesame" type="button">Sesame</button>
              <button class="chip" data-value="mustard" type="button">Mustard</button>
              <button class="chip" data-value="sulfites" type="button">Sulfites</button>
              <button class="chip" data-value="celery" type="button">Celery</button>
              <button class="chip" data-value="lupin" type="button">Lupin</button>
              <button class="chip" data-value="mollusks" type="button">Mollusks</button>
              <button class="chip" data-value="none" type="button">No allergies</button>
            </div>
            <p class="text-xs text-gray-500 mt-1">Tap chips to toggle. Selected chips will be saved to your profile.</p>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Diet</label>
            <select id="dietSelect" class="w-full h-12 rounded-xl border border-gray-200 bg-white pl-4 pr-10 text-gray-900">
              <option value="">Choose a diet...</option>
              <option value="none">None / No specific diet</option>
              <option value="vegetarian">Vegetarian</option>
              <option value="vegan">Vegan</option>
              <option value="pescatarian">Pescatarian</option>
              <option value="flexitarian">Flexitarian</option>
              <option value="keto">Keto / Low-carb</option>
              <option value="paleo">Paleo</option>
              <option value="mediterranean">Mediterranean</option>
              <option value="lowfat">Low-fat</option>
              <option value="whole30">Whole30</option>
              <option value="halal">Halal</option>
              <option value="kosher">Kosher</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Calorie target (pick a preset)</label>
            <select id="caloriesSelect" class="w-full h-12 rounded-xl border border-gray-200 bg-white pl-4 pr-10 text-gray-900">
              <option value="">Choose calorie target...</option>
              <option value="1200">1200 kcal â€” Weight loss (low)</option>
              <option value="1400">1400 kcal â€” Weight loss</option>
              <option value="1600">1600 kcal â€” Light activity</option>
              <option value="1800">1800 kcal â€” Moderate</option>
              <option value="2000">2000 kcal â€” Average adult</option>
              <option value="2200">2200 kcal â€” Active</option>
              <option value="2500">2500 kcal â€” High activity</option>
              <option value="custom">Custom</option>
            </select>
            <p class="text-xs text-gray-500 mt-1">Set a calorie goal with our <a href="/calculator/" class="underline">Calorie Calculator</a>. Advanced users can set macros later in settings.</p>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">What currency do you usually buy groceries in?</label>
            <select id="currencySelect" class="w-full h-12 rounded-xl border border-gray-200 bg-white pl-4 pr-10 text-gray-900">
              <option value="">Choose currency...</option>
              <option value="USD">USD â€” US Dollar</option>
              <option value="EUR">EUR â€” Euro</option>
              <option value="GBP">GBP â€” British Pound</option>
              <option value="CAD">CAD â€” Canadian Dollar</option>
              <option value="AUD">AUD â€” Australian Dollar</option>
              <option value="NZD">NZD â€” New Zealand Dollar</option>
              <option value="JPY">JPY â€” Japanese Yen</option>
              <option value="CNY">CNY â€” Chinese Yuan</option>
              <option value="INR">INR â€” Indian Rupee</option>
              <option value="SEK">SEK â€” Swedish Krona</option>
              <option value="NOK">NOK â€” Norwegian Krone</option>
              <option value="DKK">DKK â€” Danish Krone</option>
              <option value="CHF">CHF â€” Swiss Franc</option>
              <option value="BRL">BRL â€” Brazilian Real</option>
              <option value="ZAR">ZAR â€” South African Rand</option>
              <option value="MXN">MXN â€” Mexican Peso</option>
              <option value="SGD">SGD â€” Singapore Dollar</option>
              <option value="HKD">HKD â€” Hong Kong Dollar</option>
              <option value="ILS">ILS â€” Israeli Shekel</option>
              <option value="RUB">RUB â€” Russian Ruble</option>
              <option value="other">Other...</option>
            </select>
          </div>
        </div>
      </section>

      <!-- Step 3 -->
      <section id="step-3" class="card p-8 mb-8 hidden">
        <h2 class="text-2xl font-semibold text-center mb-2">Select your country of residence</h2>
        <p class="text-gray-600 text-center mb-8">This helps us customize your experience with local stores and currency</p>

        <div class="max-w-md mx-auto">
          <div class="relative">
            <select id="countrySelect" class="w-full h-12 rounded-xl border border-gray-200 bg-white pl-4 pr-10 text-gray-900">
              <option value="">Choose your country...</option>
<option>Afghanistan</option>
<option>Albania</option>
<option>Algeria</option>
<option>Andorra</option>
<option>Angola</option>
<option>Antigua and Barbuda</option>
<option>Argentina</option>
<option>Armenia</option>
<option>Australia</option>
<option>Austria</option>
<option>Azerbaijan</option>
<option>Bahamas</option>
<option>Bahrain</option>
<option>Bangladesh</option>
<option>Barbados</option>
<option>Belarus</option>
<option>Belgium</option>
<option>Belize</option>
<option>Benin</option>
<option>Bhutan</option>
<option>Bolivia</option>
<option>Bosnia and Herzegovina</option>
<option>Botswana</option>
<option>Brazil</option>
<option>Brunei</option>
<option>Bulgaria</option>
<option>Burkina Faso</option>
<option>Burundi</option>
<option>Cabo Verde</option>
<option>Cambodia</option>
<option>Cameroon</option>
<option>Canada</option>
<option>Central African Republic</option>
<option>Chad</option>
<option>Chile</option>
<option>China</option>
<option>Colombia</option>
<option>Comoros</option>
<option>Congo (Congo-Brazzaville)</option>
<option>Costa Rica</option>
<option>Croatia</option>
<option>Cuba</option>
<option>Cyprus</option>
<option>Czechia (Czech Republic)</option>
<option>Democratic Republic of the Congo</option>
<option>Denmark</option>
<option>Djibouti</option>
<option>Dominica</option>
<option>Dominican Republic</option>
<option>Ecuador</option>
<option>Egypt</option>
<option>El Salvador</option>
<option>Equatorial Guinea</option>
<option>Eritrea</option>
<option>Estonia</option>
<option>Eswatini (fmr. "Swaziland")</option>
<option>Ethiopia</option>
<option>Fiji</option>
<option>Finland</option>
<option>France</option>
<option>Gabon</option>
<option>Gambia</option>
<option>Georgia</option>
<option>Germany</option>
<option>Ghana</option>
<option>Greece</option>
<option>Grenada</option>
<option>Guatemala</option>
<option>Guinea</option>
<option>Guinea-Bissau</option>
<option>Guyana</option>
<option>Haiti</option>
<option>Holy See</option>
<option>Honduras</option>
<option>Hungary</option>
<option>Iceland</option>
<option>India</option>
<option>Indonesia</option>
<option>Iran</option>
<option>Iraq</option>
<option>Ireland</option>
<option>Israel</option>
<option>Italy</option>
<option>Jamaica</option>
<option>Japan</option>
<option>Jordan</option>
<option>Kazakhstan</option>
<option>Kenya</option>
<option>Kiribati</option>
<option>Kuwait</option>
<option>Kyrgyzstan</option>
<option>Laos</option>
<option>Latvia</option>
<option>Lebanon</option>
<option>Lesotho</option>
<option>Liberia</option>
<option>Libya</option>
<option>Liechtenstein</option>
<option>Lithuania</option>
<option>Luxembourg</option>
<option>Madagascar</option>
<option>Malawi</option>
<option>Malaysia</option>
<option>Maldives</option>
<option>Mali</option>
<option>Malta</option>
<option>Marshall Islands</option>
<option>Mauritania</option>
<option>Mauritius</option>
<option>Mexico</option>
<option>Micronesia</option>
<option>Moldova</option>
<option>Monaco</option>
<option>Mongolia</option>
<option>Montenegro</option>
<option>Morocco</option>
<option>Mozambique</option>
<option>Myanmar (formerly Burma)</option>
<option>Namibia</option>
<option>Nauru</option>
<option>Nepal</option>
<option>Netherlands</option>
<option>New Zealand</option>
<option>Nicaragua</option>
<option>Niger</option>
<option>Nigeria</option>
<option>North Korea</option>
<option>North Macedonia</option>
<option>Norway</option>
<option>Oman</option>
<option>Pakistan</option>
<option>Palau</option>
<option>Palestine State</option>
<option>Panama</option>
<option>Papua New Guinea</option>
<option>Paraguay</option>
<option>Peru</option>
<option>Philippines</option>
<option>Poland</option>
<option>Portugal</option>
<option>Qatar</option>
<option>Romania</option>
<option>Russia</option>
<option>Rwanda</option>
<option>Saint Kitts and Nevis</option>
<option>Saint Lucia</option>
<option>Saint Vincent and the Grenadines</option>
<option>Samoa</option>
<option>San Marino</option>
<option>Sao Tome and Principe</option>
<option>Saudi Arabia</option>
<option>Senegal</option>
<option>Serbia</option>
<option>Seychelles</option>
<option>Sierra Leone</option>
<option>Singapore</option>
<option>Slovakia</option>
<option>Slovenia</option>
<option>Solomon Islands</option>
<option>Somalia</option>
<option>South Africa</option>
<option>South Korea</option>
<option>South Sudan</option>
<option>Spain</option>
<option>Sri Lanka</option>
<option>Sudan</option>
<option>Suriname</option>
<option>Sweden</option>
<option>Switzerland</option>
<option>Syria</option>
<option>Tajikistan</option>
<option>Tanzania</option>
<option>Thailand</option>
<option>Timor-Leste</option>
<option>Togo</option>
<option>Tonga</option>
<option>Trinidad and Tobago</option>
<option>Tunisia</option>
<option>Turkey</option>
<option>Turkmenistan</option>
<option>Tuvalu</option>
<option>Uganda</option>
<option>Ukraine</option>
<option>United Arab Emirates</option>
<option>United Kingdom</option>
<option>United States of America</option>
<option>Uruguay</option>
<option>Uzbekistan</option>
<option>Vanuatu</option>
<option>Venezuela</option>
<option>Vietnam</option>
<option>Yemen</option>
<option>Zambia</option>
<option>Zimbabwe</option>
              <option value="other">Other...</option>
            </select>
            <span class="pointer-events-none absolute right-3 top-1/2 -translate-y-1/2 text-gray-400">â–¾</span>
          </div>
        </div>
      </section>

      <!-- Navigation -->
      <div class="flex justify-between items-center">
        <button id="backBtn" class="px-5 h-11 rounded-xl border border-gray-300 bg-white text-gray-800 hover:bg-gray-50" type="button">Back</button>

        <div class="flex gap-2" aria-hidden="true">
          <div id="dot1" class="w-3 h-3 rounded-full" style="background:#12B981;"></div>
          <div id="dot2" class="w-3 h-3 rounded-full bg-gray-200"></div>
          <div id="dot3" class="w-3 h-3 rounded-full bg-gray-200"></div>
        </div>

        <button id="nextBtn" class="px-6 h-11 rounded-xl btn-gradient" type="button">Next</button>
        <a id="finishLink" href="#" class="hidden">
          <button id="finishBtn" class="px-6 h-11 rounded-xl btn-gradient" type="button">Finish</button>
        </a>
      </div>
    </div>
  </main>

  <footer class="bg-white border-t border-gray-200 py-6">
    <div class="max-w-5xl mx-auto px-6 text-center text-sm text-gray-500">Â© 2025 GoodPlates. All rights reserved.</div>
  </footer>

  <!-- Firebase + App logic (type=module) -->
  <!-- REPLACE your existing <script type="module"> ... </script> with this -->
<script type="module">
  // ---------- FIREBASE CONFIG (keep your existing values) ----------
  const firebaseConfig = {
    apiKey: "AIzaSyCOHC_OvQ4onPkhLvHzZEPazmY6PRcxjnw",
    authDomain: "goodplates-7ae36.firebaseapp.com",
    projectId: "goodplates-7ae36",
    storageBucket: "goodplates-7ae36.firebasestorage.app",
    messagingSenderId: "541149626283",
    appId: "1:541149626283:web:928888f0b42cda49b7dcee",
    measurementId: "G-HKMSHM726J"
  };

  // modular SDK imports (v9 style you used)
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // UI state (unchanged)
  let currentStep = 1;
  let selectedGoals = [];
  let selectedCountry = "";
  let selectedAllergies = [];
  let selectedDiet = "";
  let selectedCalories = "";
  let selectedCurrency = "";

  const steps = [1,2,3];

  // Elements
  const stepEls = {1: document.getElementById('step-1'), 2: document.getElementById('step-2'), 3: document.getElementById('step-3')};
  const backBtn = document.getElementById('backBtn');
  const nextBtn = document.getElementById('nextBtn');
  const finishBtn = document.getElementById('finishBtn');
  const finishLink = document.getElementById('finishLink');
  const progressBar = document.getElementById('progressBar');
  const progressLabel = document.getElementById('progressLabel');
  const progressPct = document.getElementById('progressPct');
  const dots = [document.getElementById('dot1'), document.getElementById('dot2'), document.getElementById('dot3')];
  const countrySelect = document.getElementById('countrySelect');
  const allergiesContainer = document.getElementById('allergiesContainer');
  const dietSelect = document.getElementById('dietSelect');
  const caloriesSelect = document.getElementById('caloriesSelect');
  const currencySelect = document.getElementById('currencySelect');

  // create an inline status element next to finish button (no alert)
  const statusEl = document.createElement('div');
  statusEl.id = 'onboardingStatus';
  statusEl.style.marginLeft = '12px';
  statusEl.style.alignSelf = 'center';
  statusEl.style.fontSize = '0.95rem';
  statusEl.style.color = '#065f46'; // greenish for success
  statusEl.style.display = 'inline-block';
  statusEl.textContent = '';
  // insert after the finishLink container so it shows next to the button
  finishLink.parentElement.appendChild(statusEl);

  // Helpers
  function updateProgress(){
    const totalSteps = steps.length;
    const pct = Math.round((currentStep / totalSteps) * 100);
    progressBar.style.width = pct + '%';
    progressLabel.textContent = `Step ${currentStep} of ${totalSteps}`;
    progressPct.textContent = `${pct}% Complete`;
    dots.forEach((d,i) => { d.style.background = (i < currentStep) ? '#12B981' : '#E5E7EB'; });
  }

  function showStep(step){
    steps.forEach(s => stepEls[s].classList.toggle('hidden', s !== step));
    backBtn.disabled = step === 1;
    const canGo = canProceed();
    if (step < 3) { nextBtn.classList.remove('hidden'); finishLink.classList.add('hidden'); nextBtn.disabled = !canGo; }
    else { nextBtn.classList.add('hidden'); finishLink.classList.remove('hidden'); finishBtn.disabled = !canGo; }
    updateProgress();
  }

  function canProceed(){
    if (currentStep === 1) return selectedGoals.length > 0;
    if (currentStep === 2) return selectedDiet !== "" && selectedCalories !== "" && selectedCurrency !== "";
    if (currentStep === 3) return selectedCountry !== "";
    return false;
  }

  // Step 1: toggle multiple goals
  stepEls[1].querySelectorAll('[data-goal]').forEach(card => {
    card.addEventListener('click', () => {
      const goal = card.dataset.goal;
      const idx = selectedGoals.indexOf(goal);
      if (idx === -1) { selectedGoals.push(goal); card.setAttribute('data-selected','true'); card.classList.add('ring-2','ring-green-600','bg-green-50'); card.setAttribute('aria-pressed','true'); }
      else { selectedGoals.splice(idx,1); card.removeAttribute('data-selected'); card.classList.remove('ring-2','ring-green-600','bg-green-50'); card.setAttribute('aria-pressed','false'); }
      nextBtn.disabled = !canProceed();
    });
  });

  // Allergies chips handlers
  allergiesContainer.querySelectorAll('button[data-value]').forEach(btn => {
    btn.addEventListener('click', () => {
      const val = btn.dataset.value;
      if (val === 'none') {
        selectedAllergies = ['none'];
        allergiesContainer.querySelectorAll('button').forEach(b => b.classList.toggle('chip-selected', b.dataset.value === 'none'));
      } else {
        const i = selectedAllergies.indexOf(val);
        if (i === -1) {
          const noneIdx = selectedAllergies.indexOf('none');
          if (noneIdx !== -1) selectedAllergies.splice(noneIdx,1);
          selectedAllergies.push(val);
          btn.classList.add('chip-selected');
        } else {
          selectedAllergies.splice(i,1);
          btn.classList.remove('chip-selected');
        }
        allergiesContainer.querySelectorAll('button[data-value="none"]').forEach(b => {
          b.classList.toggle('chip-selected', selectedAllergies.length === 1 && selectedAllergies[0] === 'none');
        });
      }
    });
  });

  // diet/calories/currency/country handlers
  dietSelect.addEventListener('change', e => { selectedDiet = e.target.value; updateNextFinishState(); });
  caloriesSelect.addEventListener('change', e => { selectedCalories = e.target.value; updateNextFinishState(); });
  currencySelect.addEventListener('change', e => { selectedCurrency = e.target.value; updateNextFinishState(); });
  countrySelect.addEventListener('change', e => { selectedCountry = e.target.value; updateNextFinishState(); });

  function updateNextFinishState(){ nextBtn.disabled = !canProceed(); finishBtn.disabled = !canProceed(); }

  // navigation
  backBtn.addEventListener('click', () => { currentStep = Math.max(1, currentStep - 1); showStep(currentStep); });
  nextBtn.addEventListener('click', () => { if (!canProceed()) return; currentStep = Math.min(3, currentStep + 1); showStep(currentStep); });

  // ---------- AUTH & ONBOARDING CHECK ----------
  // Helper: wait for the auth state once
  function currentUserOnce() {
    return new Promise((resolve) => {
      const unsub = onAuthStateChanged(auth, (user) => {
        unsub();
        resolve(user);
      });
      // no timeout required; onAuthStateChanged usually fires quickly
    });
  }

  (async function requireAuthAndProfile() {
    try {
      const user = await currentUserOnce();

      // if no logged-in user OR anonymous user -> redirect to login form
      if (!user || user.isAnonymous) {
        // Redirect to your login form and include next param
        window.location.href = '/login-form/?next=/onboarding/';
        return;
      }

      // user is signed in (non-anonymous). Check profile doc
      const uid = user.uid;
      const profileRef = doc(db, 'profiles', uid);
      const snap = await getDoc(profileRef);

      if (snap.exists()) {
        const data = snap.data() || {};
        if (data.onboardingComplete === true) {
          // already onboarded -> go to dashboard
          window.location.href = '/dashboard/';
          return;
        }
        // If desired, we could pre-fill selections from profile (not implemented here)
      } else {
        // create a minimal profile doc to ensure the doc exists and record start
        await setDoc(profileRef, {
          onboardingComplete: false,
          onboardingStartedAt: serverTimestamp()
        }, { merge: true });
      }

      // if we reach here, the user is allowed to complete onboarding â€” enable UI (it's already interactive)
    } catch (err) {
      console.error('Auth/profile check failed', err);
      // If something is wrong, fall back to redirect to login
      window.location.href = '/login-form/?next=/onboarding/';
    }
  })();

  // ---------- FIRESTORE SAVE & REDIRECT (no anonymous fallback) ----------
  async function saveProfileAndRedirect() {
    finishBtn.disabled = true;
    const prevText = finishBtn.textContent;
    finishBtn.textContent = 'Saving...';
    statusEl.style.color = '#065f46';
    statusEl.textContent = '';

    try {
      // ensure user is still signed in
      const user = auth.currentUser;
      if (!user || user.isAnonymous) {
        // no proper auth; send to login
        window.location.href = '/login-form/?next=/onboarding/';
        return;
      }

      const uid = user.uid;
      const profileRef = doc(db, 'profiles', uid);
      const userRef = doc(db, 'users', uid);

      // Build profile payload
      const caloriesNumber = selectedCalories && selectedCalories !== 'custom' ? parseInt(selectedCalories, 10) : null;

      const profilePatch = {
        'nutritionInfo': { allergies: selectedAllergies.filter(Boolean), dietaryType: selectedDiet || '' },
        'nutritionGoals': { calories: caloriesNumber },
        defaultCurrency: selectedCurrency || '',
        dietTags: selectedGoals || [],
        location: selectedCountry || '',
        onboardingComplete: true,
        onboardingCompletedAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      };

      // If profile exists, merge; otherwise create with createdAt
      const existing = await getDoc(profileRef);
      if (existing.exists()) {
        await updateDoc(profileRef, profilePatch);
      } else {
        await setDoc(profileRef, { ...profilePatch, createdAt: serverTimestamp() }, { merge: true });
      }

      // Update small user fields in users/{uid}
      const userPatch = {};
      if (selectedGoals.length) userPatch.dietTags = selectedGoals;
      if (selectedCountry) userPatch.location = selectedCountry;
      if (Object.keys(userPatch).length) {
        await setDoc(userRef, userPatch, { merge: true });
      }

            // show success briefly and redirect to a safe "next" target if present
      // (prefers ?next=... then sessionStorage.gp-login-next; prevents open-redirects)
      function getRawNext() {
        try {
          const params = new URLSearchParams(location.search);
          const q = params.get('next');
          if (q) return decodeURIComponent(String(q));
        } catch (e) { /* ignore */ }
        try {
          const s = sessionStorage.getItem('gp-login-next');
          if (s) return s;
        } catch (e) { /* ignore */ }
        return null;
      }

      function validateNextTarget(next) {
        if (!next) return null;
        // Reject absolute/external URLs
        if (next.startsWith('http:') || next.startsWith('https:') || next.startsWith('//')) return null;
        // Must start with a single slash to be a path
        if (!next.startsWith('/')) return null;
        try {
          const url = new URL(next, location.origin);
          if (url.origin !== location.origin) return null;
          const path = url.pathname + url.search + url.hash;
          // Prevent redirect loops and avoid sending back to auth pages
          const blockedStarts = ['/login', '/signup', '/onboarding'];
          for (const b of blockedStarts) {
            if (path === b || path.startsWith(b + '/') || path.startsWith(b + '?')) return null;
          }
          // reasonable length guard
          if (path.length > 2048) return null;
          return path;
        } catch (e) {
          return null;
        }
      }

      const rawNext = getRawNext();
      const safeNext = validateNextTarget(rawNext);

      // clean up the stored marker so it won't be reused
      try { sessionStorage.removeItem('gp-login-next'); } catch (_) {}

      // show inline success then navigate
      // show inline success then navigate / notify parent if embedded
statusEl.style.color = '#065f46';
statusEl.textContent = 'Saved â€” redirectingâ€¦';
finishBtn.textContent = 'Saved';

// detect embedded mode (iframe) via query param ?embedded=1
const embedded = new URLSearchParams(location.search).get('embedded') === '1';

// notify parent frame (same-origin) that onboarding completed
if (embedded && window.parent && window.parent !== window) {
  try {
    window.parent.postMessage({ type: 'onboardingComplete' }, location.origin);
  } catch (e) {
    console.warn('postMessage to parent failed', e);
  }
  // If embedded, let the parent handle closing/reload â€” stop here
  return;
}

// not embedded: do the normal redirect on the standalone onboarding page
setTimeout(() => {
  window.location.href = safeNext || '/dashboard/';
}, 600);


    } catch (err) {
      console.error('Save failed', err);
      statusEl.style.color = '#b91c1c'; // crimson
      statusEl.textContent = 'Failed to save â€” try again';
      finishBtn.disabled = false;
      finishBtn.textContent = prevText;
    }
  }

  // wire finish button to save flow
  finishBtn.addEventListener('click', (e) => {
    if (!canProceed()) { e.preventDefault(); return; }
    saveProfileAndRedirect();
  });

  // Init UI
  showStep(currentStep);
</script>

</body>
</html>
