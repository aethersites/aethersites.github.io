<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>GoodPlates ‚Äî Profile (Enhanced)</title>
<style>
  :root{
    --bg:#f6fbf6; --panel:#fff; --muted:#6b7280; --text:#052012;
    --primary-dark:#0f3f22; --primary:#16a34a; --accent:linear-gradient(135deg,#11723a,#16a34a,#9bf7b7);
    --border:rgba(8,23,12,0.06); --shadow:0 8px 30px rgba(3,24,12,.08);
    --radius:12px; --sidebar-w:260px;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
  .app{display:grid;grid-template-columns:var(--sidebar-w) 1fr;min-height:100vh}
  .sidebar{padding:26px 18px;background:linear-gradient(180deg,#fff,#f4fff7);border-right:1px solid var(--border);display:flex;flex-direction:column;gap:12px}
  .logo-mark{width:44px;height:44px;border-radius:10px;background:var(--accent);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800}
  .nav-item{display:flex;gap:10px;align-items:center;padding:10px;border-radius:10px;color:var(--muted);text-decoration:none;font-weight:700}
  .nav-item.active{background:linear-gradient(90deg, rgba(22,163,74,0.12), rgba(22,163,74,0.04));color:var(--primary-dark);box-shadow: inset 4px 0 0 0 var(--primary)}
  .upgrade{margin-top:auto;background:linear-gradient(135deg,#1b8a4b,#16a34a);color:white;padding:14px;border-radius:12px}
  .main{padding:24px;overflow:auto}
  .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
  .search{flex:1;max-width:640px;display:flex;gap:8px;padding:8px 12px;border-radius:999px;background:#fff;border:1px solid var(--border)}
  .search input{border:0;outline:none;background:transparent;width:100%}
  .page-title{font-size:28px;font-weight:800;margin:0}
  .page-sub{color:var(--muted);font-size:14px;margin-bottom:16px}
  .grid{display:grid;grid-template-columns:360px 1fr;gap:18px}
  .card{background:var(--panel);border-radius:12px;padding:18px;box-shadow:var(--shadow);border:1px solid var(--border)}
  .avatar-wrap{display:flex;flex-direction:column;align-items:center;gap:12px}
  .avatar{width:120px;height:120px;border-radius:14px;overflow:hidden;border:4px solid #fff;box-shadow:0 6px 18px rgba(3,24,12,0.08)}
  .avatar img{width:100%;height:100%;object-fit:cover}
  .upload{display:flex;gap:8px;align-items:center}
  form{display:flex;flex-direction:column;gap:12px}
  label{font-size:13px;color:var(--muted);margin-bottom:6px;display:block}
  input[type="text"], input[type="email"], input[type="tel"], textarea, select {
    width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);font-size:14px;background:transparent;
  }
  textarea{min-height:100px;resize:vertical}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .actions{display:flex;gap:12px;margin-top:8px;align-items:center}
  .btn{display:inline-flex;align-items:center;gap:8px;border:0;padding:10px 14px;border-radius:999px;cursor:pointer;font-weight:700;color:white;background:var(--accent);box-shadow:0 8px 22px rgba(16,163,74,.12)}
  .btn.ghost{background:transparent;color:var(--primary-dark);border:1px solid rgba(16,163,74,.08);box-shadow:none}
  .danger{background:linear-gradient(135deg,#d9534f,#c12b2b)}
  .meta{font-size:13px;color:var(--muted)}
  .muted{color:var(--muted)}
  .small{font-size:13px}
  .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#f3fff3;border:1px solid rgba(16,163,74,0.06);color:var(--primary-dark);font-weight:700}
  .field-error{color:#b91c1c;font-size:13px;margin-top:6px}
  .status {
    display:inline-block;padding:6px 10px;border-radius:999px;font-weight:700;font-size:13px;margin-left:8px;
  }
  .status.saving{background:#fff7e6;color:#a66a00}
  .status.saved{background:#e6f9ee;color:var(--primary-dark)}
  .status.unsaved{background:#ffefef;color:#a00d12}
  .chips{display:flex;flex-wrap:wrap;gap:8px}
  .chip{padding:6px 10px;border-radius:999px;border:1px solid var(--border);cursor:pointer;background:transparent}
  .chip.selected{background:linear-gradient(90deg, rgba(22,163,74,0.12), rgba(22,163,74,0.04));border-color:rgba(22,163,74,0.22)}
  .strength{height:8px;border-radius:6px;background:#f3f3f3;overflow:hidden}
  .strength > i{display:block;height:100%;width:0%;background:linear-gradient(90deg,#ff4d4d,#ffb84d,#6ee7b7);transition:width .28s}
  .toast{position:fixed;right:20px;bottom:20px;background:#052012;color:#fff;padding:12px 16px;border-radius:10px;box-shadow:0 8px 30px rgba(0,0,0,.12);opacity:0;transform:translateY(12px);transition:all .28s}
  .toast.show{opacity:1;transform:none}
  @media(max-width:980px){
    .app{grid-template-columns:72px 1fr}
    .grid{grid-template-columns:1fr;gap:12px}
  }
</style>
</head>
<body>
<div class="app">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div style="display:flex;align-items:center;gap:12px">
      <div class="logo-mark">GP</div>
      <div>
        <div style="font-weight:800">GoodPlates</div>
        <div style="font-size:12px;color:var(--muted)">Cook ‚Ä¢ Order ‚Ä¢ Track</div>
      </div>
    </div>
    <a class="nav-item" href="#">üè† Home</a>
    <a class="nav-item" href="#">üç≥ Recipes</a>
    <a class="nav-item" href="#">üìù Grocery List</a>
    <a class="nav-item active" href="#">üë§ Profile</a>
    <div class="upgrade">
      <div style="font-weight:800">Upgrade to PRO</div>
      <div style="font-size:13px;margin-top:6px">Premium meal plans & analytics</div>
    </div>
  </aside>

  <!-- Main -->
  <main class="main">
    <div class="topbar">
      <div class="search" aria-hidden>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M21 21l-4.35-4.35" stroke="#6b7280" stroke-width="1.6" stroke-linecap="round"/></svg>
        <input placeholder="Search recipes, orders, ingredients..." />
      </div>
      <div style="display:flex;gap:12px;align-items:center">
        <div id="loggedAs" class="meta muted"></div>
        <button id="logoutBtn" class="btn ghost" style="display:none">Logout</button>
      </div>
    </div>
    <h2 class="page-title">Profile</h2>
    <div class="page-sub">Enhanced profile settings ‚Äî autosave, cloud save, and quick sync to server.</div>
    <div class="grid">
      <!-- left: avatar & prefs -->
      <aside class="card">
        <div class="avatar-wrap">
          <div class="avatar" id="avatarPreview">
            <img src="https://i.pravatar.cc/300?img=5" alt="avatar">
          </div>
          <div style="text-align:center">
            <div id="previewName" style="font-weight:800;font-size:18px">Guest</div>
            <div id="previewEmail" class="muted small">not logged in</div>
          </div>
          <div style="width:100%;margin-top:8px">
            <label class="small muted">Upload avatar (png/jpg)</label>
            <div class="upload">
              <input id="avatarInput" type="file" accept="image/*" />
              <button id="removeAvatar" class="btn ghost" style="padding:8px 10px">Remove</button>
            </div>
            <div class="meta small" style="margin-top:6px">Images are resized & compressed client-side (400√ó400)</div>
          </div>
          <div style="width:100%;margin-top:12px">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div class="meta">Profile status</div>
              <div id="saveStatus" class="status unsaved">Not saved</div>
            </div>
          </div>
        </div>
      </aside>

      <!-- right: editable form -->
      <section class="card">
        <form id="profileForm">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:800">Account Details</div>
            <div class="meta small">Autosaves changes ‚Äî you can also Save</div>
          </div>
          <div style="margin-top:12px">
            <label for="fullName">Full name <span style="color:#a00d12">*</span></label>
            <input id="fullName" type="text" placeholder="Jane Doe" required />
            <div id="errName" class="field-error" style="display:none"></div>
          </div>
          <div>
            <label for="email">Email (used as account id) <span style="color:#a00d12">*</span></label>
            <input id="email" type="email" placeholder="you@domain.com" required disabled />
            <div id="errEmail" class="field-error" style="display:none"></div>
          </div>
          <div class="row">
            <div>
              <label for="phone">Phone</label>
              <input id="phone" type="tel" placeholder="+1 555 555 5555" />
              <div id="errPhone" class="field-error" style="display:none"></div>
            </div>
            <div>
              <label for="location">Location</label>
              <input id="location" type="text" placeholder="City, State" />
            </div>
          </div>
          <div>
            <label for="address">Default Delivery Address</label>
            <input id="address" type="text" placeholder="123 Green St, Apt 5" />
          </div>
          <div>
            <label for="dietTags">Dietary Preferences</label>
            <div class="chips" id="dietChips"></div>
            <div class="meta small" style="margin-top:6px">Click to toggle multiple preferences</div>
          </div>
          <div class="row">
            <div>
              <label for="nutritionGoals">Nutrition goals</label>
              <input id="nutritionGoals" type="text" placeholder="Maintain 1800-2000 kcal/day" />
            </div>
            <div>
              <label for="units">Units</label>
              <select id="units"><option value="metric">Metric</option><option value="imperial">Imperial</option></select>
            </div>
          </div>
          <div>
            <label for="preferredDelivery">Preferred Delivery Time</label>
            <select id="preferredDelivery">
              <option value="">No preference</option>
              <option value="morning">Morning (8am‚Äì11am)</option>
              <option value="afternoon">Afternoon (12pm‚Äì4pm)</option>
              <option value="evening">Evening (5pm‚Äì9pm)</option>
            </select>
          </div>
          <div>
            <label for="bio">Bio</label>
            <textarea id="bio" placeholder="A short bio..."></textarea>
          </div>
          <hr style="border:none;border-top:1px dashed var(--border)"/>
          <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-top:6px">
            <button id="saveBtn" class="btn" type="submit">Save Profile</button>
            <button id="deleteBtn" class="btn danger" type="button">Delete Profile</button>
          </div>
        </form>
      </section>
    </div>
  </main>
</div>
<script type="module">
import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCOHC_OvQ4onPkhLvHzZEPazmY6PRcxjnw",
  authDomain: "goodplates-7ae36.firebaseapp.com",
  projectId: "goodplates-7ae36",
  storageBucket: "goodplates-7ae36.appspot.com",
  messagingSenderId: "541149626283",
  appId: "1:541149626283:web:928888f0b42cda49b7dcee",
  measurementId: "G-HKMSHM726J"
};

let app;
if (getApps().length === 0) app = initializeApp(firebaseConfig);
else app = getApp();

const auth = getAuth(app);
const db = getFirestore(app);

const refs = {
  fullName: document.getElementById('fullName'),
  email: document.getElementById('email'),
  phone: document.getElementById('phone'),
  location: document.getElementById('location'),
  address: document.getElementById('address'),
  nutritionGoals: document.getElementById('nutritionGoals'),
  preferredDelivery: document.getElementById('preferredDelivery'),
  bio: document.getElementById('bio'),
  units: document.getElementById('units'),
  dietChips: document.getElementById('dietChips'),
  saveStatus: document.getElementById('saveStatus'),
  saveBtn: document.getElementById('saveBtn'),
  deleteBtn: document.getElementById('deleteBtn'),
  logoutBtn: document.getElementById('logoutBtn'),
  previewName: document.getElementById('previewName'),
  previewEmail: document.getElementById('previewEmail'),
  avatarInput: document.getElementById('avatarInput'),
  avatarPreviewImg: document.querySelector('#avatarPreview img'),
  removeAvatarBtn: document.getElementById('removeAvatar'),
  loggedAs: document.getElementById('loggedAs')
};

const defaultDietTags = ['Vegetarian','Vegan','Gluten-Free','Keto','Paleo','Halal','Dairy-Free','Nut-Free'];

function renderDietChips(selected=[]) {
  refs.dietChips.innerHTML = '';
  defaultDietTags.forEach(tag => {
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'chip' + (selected.includes(tag) ? ' selected' : '');
    btn.textContent = tag;
    btn.addEventListener('click', () => {
      btn.classList.toggle('selected');
      scheduleAutosave();
    });
    refs.dietChips.appendChild(btn);
  });
}

function getProfileFromForm() {
  const dietTags = Array.from(refs.dietChips.querySelectorAll('.chip.selected')).map(n => n.textContent);
  return {
    fullName: refs.fullName.value.trim(),
    email: refs.email.value.trim(),
    phone: refs.phone.value.trim(),
    location: refs.location.value.trim(),
    address: refs.address.value.trim(),
    nutritionGoals: refs.nutritionGoals.value.trim(),
    preferredDelivery: refs.preferredDelivery.value,
    bio: refs.bio.value.trim(),
    units: refs.units.value,
    dietTags,
    avatarDataUrl: refs.avatarPreviewImg.src && refs.avatarPreviewImg.src.startsWith('data:') ? refs.avatarPreviewImg.src : '',
    updatedAt: new Date().toISOString()
  };
}

function fillForm(profile, email) {
  refs.fullName.value = profile.fullName || '';
  refs.email.value = profile.email || email || '';
  refs.phone.value = profile.phone || '';
  refs.location.value = profile.location || '';
  refs.address.value = profile.address || '';
  refs.nutritionGoals.value = profile.nutritionGoals || '';
  refs.preferredDelivery.value = profile.preferredDelivery || '';
  refs.bio.value = profile.bio || '';
  refs.units.value = profile.units || 'metric';
  renderDietChips(profile.dietTags || []);
  if(profile.avatarDataUrl) refs.avatarPreviewImg.src = profile.avatarDataUrl;
  else refs.avatarPreviewImg.src = 'https://i.pravatar.cc/300?img=5';
  refs.previewName.textContent = profile.fullName || profile.email || '‚Äî';
  refs.previewEmail.textContent = profile.email || '';
}

async function saveToFirestore(user, data) {
  refs.saveStatus.textContent = 'Saving...';
  refs.saveStatus.className = 'status saving';
  await setDoc(doc(db, "users", user.uid, "profile", "main"), data, { merge: true });
  refs.saveStatus.textContent = 'Saved';
  refs.saveStatus.className = 'status saved';
}

async function loadProfile(user) {
  const snap = await getDoc(doc(db, "users", user.uid, "profile", "main"));
  if (snap.exists()) fillForm(snap.data(), user.email);
  else fillForm({email: user.email}, user.email);
  refs.loggedAs.textContent = 'Signed in as ' + (user.displayName || user.email);
  refs.previewName.textContent = user.displayName || user.email || '';
  refs.previewEmail.textContent = user.email || '';
}

let autosaveTimer;
function scheduleAutosave() {
  clearTimeout(autosaveTimer);
  autosaveTimer = setTimeout(() => {
    getAuth().onAuthStateChanged(user => {
      if(user) saveToFirestore(user, getProfileFromForm());
    });
  }, 1200);
}

// Avatar upload/resize
function resizeImageFileToDataUrl(file, size=400, quality=0.85){
  return new Promise((resolve, reject)=>{
    const img = new Image();
    const reader = new FileReader();
    reader.onload = e=>{
      img.onload = ()=>{
        const canvas = document.createElement('canvas');
        canvas.width = size; canvas.height = size;
        const ctx = canvas.getContext('2d');
        const sw = img.naturalWidth, sh = img.naturalHeight;
        const sRatio = Math.max(size/sw, size/sh);
        const dw = sw * sRatio, dh = sh * sRatio;
        const dx = (size - dw)/2, dy = (size - dh)/2;
        ctx.fillStyle = '#fff'; ctx.fillRect(0,0,size,size);
        ctx.drawImage(img, dx, dy, dw, dh);
        const dataUrl = canvas.toDataURL('image/jpeg', quality);
        resolve(dataUrl);
      };
      img.onerror = reject;
      img.src = e.target.result;
    };
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

refs.avatarInput.addEventListener('change', async (e)=>{
  const f = e.target.files && e.target.files[0];
  if(!f) return;
  if(!f.type.startsWith('image/')){ alert('Please upload an image'); return; }
  refs.saveStatus.textContent = 'Processing image...';
  refs.saveStatus.className = 'status saving';
  try{
    const url = await resizeImageFileToDataUrl(f, 400, 0.85);
    refs.avatarPreviewImg.src = url;
    scheduleAutosave();
  }catch(err){ alert('Image processing failed'); }
});
refs.removeAvatarBtn.addEventListener('click', (e)=>{
  e.preventDefault();
  refs.avatarPreviewImg.src = 'https://i.pravatar.cc/300?img=5';
  scheduleAutosave();
});

refs.saveBtn.addEventListener('click', e => {
  e.preventDefault();
  getAuth().onAuthStateChanged(user => {
    if(user) saveToFirestore(user, getProfileFromForm());
  });
});

refs.deleteBtn.addEventListener('click', async ()=>{
  getAuth().onAuthStateChanged(async user => {
    if (user && confirm('Delete profile from cloud? This cannot be undone.')) {
      await deleteDoc(doc(db, "users", user.uid, "profile", "main"));
      fillForm({email: user.email}, user.email);
      refs.saveStatus.textContent = 'Deleted';
      refs.saveStatus.className = 'status unsaved';
    }
  });
});

refs.logoutBtn.addEventListener('click', async () => {
  await signOut(auth);
  window.location.href = '/login.html';
});

onAuthStateChanged(auth, user => {
  if (!user) {
    window.location.href = '/login.html';
    return;
  }
  refs.email.disabled = true;
  loadProfile(user);
  renderDietChips([]);
  document.getElementById('profileForm').addEventListener('input', scheduleAutosave);
});
</script>
</body>
</html>
