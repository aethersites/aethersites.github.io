<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Budget Page</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-white-50 font-sans text-gray-900">


<!-- Hero Section -->
<style>
  /* Pulling key variables & classes from the desired hero design */
  :root {
    --fg: #0f172a; /* slate-900 */
    --muted: #6b7280; /* gray-500 */
    --muted-2: #9ca3af; /* gray-400 */
    --border: #e5e7eb; /* gray-200 */
    --surface: #ffffff;
    --primary: #16a34a; /* green-600 */
    --primary-700: #15803d; /* green-700 */
    --primary-100: #dcfce7; /* green-100 */
    --shadow: 0 1px 2px rgba(0,0,0,.06), 0 8px 24px rgba(2,6,23,.06);
    --radius: 16px;
  }
  .hero {
    background: linear-gradient(180deg,#f0fdf4,#f7fff8);
    font-family: 'Helvetica', sans-serif;
  }
  .hero h1 {
    font-size: 40px;
    line-height: 1.2;
    font-weight: 800;
    margin-top: 12px;
    color: var(--fg);
  }
  .hero p {
    color: var(--muted);
    font-size: 1rem;
  }
  .badge {
    display: inline-flex;
    align-items: center;
    font-size: 14px;
    border: 1px solid rgba(22, 163, 74, .25);
    padding: 4px 12px;
    border-radius: 999px;
    background: var(--primary-100);
    color: var(--primary);
    font-weight: 500;
  }
  .stat-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 16px;
    box-shadow: var(--shadow);
  }
  .stat-title {
    display: flex;
    align-items: center;
    gap: 8px;
    color: var(--primary);
    font-size: 14px;
    font-weight: 500;
    margin-bottom: 4px;
  }
  .stat-value {
    font-size: 24px;
    font-weight: 700;
    margin: 0;
    color: var(--fg);
  }
  .stat-sub {
    font-size: 12px;
    color: var(--muted-2);
    margin: 0;
  }
  .hero-img {
    border-radius: var(--radius);
    box-shadow: var(--shadow);
  }
</style>

<section class="hero py-16 px-6 lg:px-8">
  <div class="max-w-7xl mx-auto grid lg:grid-cols-2 gap-12 items-center">
    
    <!-- Left Column -->
    <div>
      <span class="badge">💰 Smart Budget Tracking</span>
      <h1>Master Your <span style="color: var(--primary)">Grocery Budget</span></h1>
      <p class="mb-6">
        Track every dollar, analyze spending patterns, and discover smart ways to save while maintaining a healthy and delicious meal plan.
      </p>

      <!-- Stats -->
      <div class="grid grid-cols-2 gap-4">
        <div class="stat-card">
          <div class="stat-title">💵 <span>This Month</span></div>
          <!-- replaced hardcoded with dynamic element -->
          <p id="totalSpentVal" class="stat-value">—</p>
          <p id="pctOfBudget" class="stat-sub">—</p>
        </div>
        <div class="stat-card">
          <div class="stat-title">🎯 <span>Saved</span></div>
          <p id="savedVal" class="stat-value">—</p>
          <p id="savedSub" class="stat-sub">—</p>
        </div>
      </div>
    </div>

    <!-- Right Column -->
    <div>
      <img src="budget-hero.jpg" alt="Budget tracking dashboard" class="hero-img w-full" />
    </div>

  </div>
</section>

  <!-- Overview Cards -->
  <section class="py-12 px-6 lg:px-8">
    <div class="max-w-7xl mx-auto">
      <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-6 mb-12">
        <!-- Card 1 -->
        <div class="border border-green-200 rounded-xl bg-white p-6">
          <div class="flex items-center justify-between mb-4">
            <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">💵</div>
            <span id="pctChangeBadge" class="bg-green-100 text-green-700 border border-green-300 px-2 py-1 rounded-full text-xs">—</span>
          </div>
          <h3 id="cardTotalSpent" class="text-2xl font-bold">—</h3>
          <p class="text-sm text-green-800/80">Total Spent This Month</p>
          <div class="w-full bg-green-200 h-2 rounded mt-3">
            <div id="budgetProgressBar" class="bg-green-600 h-2 rounded" style="width:0%"></div>
          </div>
          <p id="budgetPctText" class="text-xs text-green-700 mt-1">—</p>
        </div>

        <!-- Card 2 -->
        <div class="border border-green-200 rounded-xl bg-white p-6">
          <div class="flex items-center justify-between mb-4">
            <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">🎯</div>
            <span id="onTrackBadge" class="bg-green-100 text-green-700 border border-green-300 px-2 py-1 rounded-full text-xs">—</span>
          </div>
          <h3 id="avgPerWeek" class="text-2xl font-bold">—</h3>
          <p class="text-sm text-green-800/80">Average Per Week</p>
          <div class="mt-3 text-xs text-green-800/70 flex justify-between">
            <span id="weeklyBudgetLabel">Weekly Budget: —</span>
            <span id="weeklyStatus" class="text-green-700">—</span>
          </div>
        </div>

        <!-- Card 3 -->
        <div class="border border-green-200 rounded-xl bg-white p-6">
          <div class="flex items-center justify-between mb-4">
            <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">📈</div>
            <span id="savedBadge" class="bg-green-100 text-green-700 border border-green-300 px-2 py-1 rounded-full text-xs">—</span>
          </div>
          <h3 id="moneySaved" class="text-2xl font-bold">—</h3>
          <p class="text-sm text-green-800/80">Money Saved</p>
          <p id="savedNote" class="text-xs text-green-700 mt-3">—</p>
        </div>

        <!-- Card 4 -->
        <div class="border border-green-200 rounded-xl bg-white p-6">
          <div class="flex items-center justify-between mb-4">
            <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">🛒</div>
            <span id="tripCountBadge" class="bg-green-100 text-green-700 border border-green-300 px-2 py-1 rounded-full text-xs">—</span>
          </div>
          <h3 id="avgPerTrip" class="text-2xl font-bold">—</h3>
          <p class="text-sm text-green-800/80">Avg Per Shopping Trip</p>
          <p id="tripsNote" class="text-xs text-green-800/70 mt-3">—</p>
        </div>
      </div>

      <!-- Weekly Breakdown & Category Breakdown -->
      <div class="grid lg:grid-cols-2 gap-8 mb-12">
        <!-- Weekly Spending -->
        <div class="border border-green-200 rounded-xl bg-white p-6">
          <h3 class="text-lg font-semibold mb-2">📊 Weekly Spending Breakdown</h3>
          <p class="text-sm text-green-800/70 mb-4">Track your spending patterns throughout the month</p>

          <div class="space-y-4">
            <div>
              <div class="flex justify-between text-sm">
                <span class="font-medium">Week 1</span>
                <span class="text-green-800"><span id="week1Amount">—</span> <span id="week1PctBadge" class="bg-green-100 text-green-700 px-1 rounded text-xs">—</span></span>
              </div>
              <div class="w-full bg-green-200 h-2 rounded mt-1">
                <div id="week1Bar" class="bg-green-600 h-2 rounded" style="width:0%"></div>
              </div>
            </div>
            <div>
              <div class="flex justify-between text-sm">
                <span class="font-medium">Week 2</span>
                <span class="text-green-800"><span id="week2Amount">—</span> <span id="week2PctBadge" class="bg-red-100 text-red-700 px-1 rounded text-xs">—</span></span>
              </div>
              <div class="w-full bg-green-200 h-2 rounded mt-1">
                <div id="week2Bar" class="bg-red-500 h-2 rounded" style="width:0%"></div>
              </div>
            </div>
            <div>
              <div class="flex justify-between text-sm">
                <span class="font-medium">Week 3</span>
                <span class="text-green-800"><span id="week3Amount">—</span> <span id="week3PctBadge" class="bg-green-100 text-green-700 px-1 rounded text-xs">—</span></span>
              </div>
              <div class="w-full bg-green-200 h-2 rounded mt-1">
                <div id="week3Bar" class="bg-green-600 h-2 rounded" style="width:0%"></div>
              </div>
            </div>
            <div>
              <div class="flex justify-between text-sm">
                <span class="font-medium">Week 4</span>
                <span class="text-green-800"><span id="week4Amount">—</span> <span id="week4PctBadge" class="bg-red-100 text-red-700 px-1 rounded text-xs">—</span></span>
              </div>
              <div class="w-full bg-green-200 h-2 rounded mt-1">
                <div id="week4Bar" class="bg-red-500 h-2 rounded" style="width:0%"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Spending by Category -->
        <div class="border border-green-200 rounded-xl bg-white p-6">
          <h3 class="text-lg font-semibold mb-2">🥗 Spending by Category</h3>
          <p class="text-sm text-green-800/70 mb-4">See where your grocery budget goes</p>

          <div id="categoriesList" class="space-y-3">
            <!-- script will populate category rows here -->
            <div class="text-sm muted">No category data yet</div>
          </div>
        </div>
      </div>

      <!-- Recent Transactions -->
      <div class="border border-green-200 rounded-xl bg-white p-6 mb-12">
        <h3 class="text-lg font-semibold mb-2">⏰ Recent Transactions</h3>
        <p class="text-sm text-green-800/70 mb-4">Your latest grocery purchases and spending</p>

        <div id="recentTransactions" class="space-y-4">
          <!-- JS will populate recent transaction rows here -->
          <div class="text-sm muted">No transactions yet</div>
        </div>

        <div class="text-center mt-6">
          <button class="px-4 py-2 border border-green-300 rounded-lg text-green-700 hover:bg-green-100">View All Transactions</button>
        </div>
      </div>

      <!-- Savings Tips -->
      <div class="border-2 border-green-300 rounded-xl bg-white p-6 shadow">
        <h3 class="text-lg font-semibold mb-2">🎯 Smart Savings Tips</h3>
        <p class="text-sm text-green-800/70 mb-6">Personalized recommendations to optimize your grocery budget</p>

        <div class="grid md:grid-cols-3 gap-6">
          <div class="space-y-3 p-4 bg-green-50 rounded-2xl">
            <div class="flex justify-between">
              <h4 class="font-semibold">Switch to seasonal produce</h4>
              <span class="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded">Easy</span>
            </div>
            <p class="text-sm text-green-800/80">Save 15-20% by choosing in-season vegetables and fruits</p>
            <div class="flex justify-between items-center">
              <span class="text-lg font-bold text-green-700">$12-15/week</span>
              <button class="px-3 py-1 border border-green-300 rounded text-green-700 hover:bg-green-100 text-sm">Try This</button>
            </div>
          </div>

          <div class="space-y-3 p-4 bg-green-50 rounded-2xl">
            <div class="flex justify-between">
              <h4 class="font-semibold">Buy generic brands</h4>
              <span class="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded">Easy</span>
            </div>
            <p class="text-sm text-green-800/80">Generic staples can save you up to 30% without compromising quality</p>
            <div class="flex justify-between items-center">
              <span class="text-lg font-bold text-green-700">$8-12/week</span>
              <button class="px-3 py-1 border border-green-300 rounded text-green-700 hover:bg-green-100 text-sm">Try This</button>
            </div>
          </div>

          <div class="space-y-3 p-4 bg-green-50 rounded-2xl">
            <div class="flex justify-between">
              <h4 class="font-semibold">Meal prep on Sundays</h4>
              <span class="text-xs bg
              </div>
            </div>
          </div>
        </div>
      </div>

   <script type="module">
    // --- FIREBASE CONFIG - FILL THIS WITH YOUR PROJECT'S VALUES ---
    import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
       apiKey: "AIzaSyCOHC_OvQ4onPkhLvHzZEPazmY6PRcxjnw",
    authDomain: "goodplates-7ae36.firebaseapp.com",
    projectId: "goodplates-7ae36",
    storageBucket: "goodplates-7ae36.firebasestorage.app",
    messagingSenderId: "541149626283",
    appId: "1:541149626283:web:928888f0b42cda49b7dcee",
    measurementId: "G-HKMSHM726J"
    };

    // Initialize app (idempotent)
    let app;
    if (!getApps().length) {
      app = initializeApp(firebaseConfig);
    } else {
      app = getApp();
    }
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ---- Helpers ----
    function fmtCurrency(n){
      if (n == null || isNaN(n)) return '—';
      return new Intl.NumberFormat('en-US', { style:'currency', currency:'USD' }).format(Number(n));
    }
    function safeText(id, txt){
      const el = document.getElementById(id);
      if(el) el.textContent = txt ?? '—';
    }
    function setBarWidth(id, pct){
      const el = document.getElementById(id);
      if(el) el.style.width = (isFinite(pct) ? (Math.max(0, Math.min(100, pct)) + '%') : '0%');
    }
    function parseAmount(v){
      if (v == null) return 0;
      // if value looks like integer cents (>=1000) attempt dividing by 100
      if (Number.isInteger(v) && Math.abs(v) > 1000) return v / 100;
      return Number(v) || 0;
    }
    function toMonthKey(d){
      const dt = (d instanceof Date) ? d : new Date(d);
      return `${dt.getFullYear()}-${dt.getMonth()+1}`;
    }

    // ---- Main: wait for auth ----
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        // not signed in — optionally redirect to login (your earlier behavior)
        // window.location.href = '/login.html';
        console.warn('Not signed in. Populate UI only when signed in.');
        return;
      }
      const uid = user.uid;

      // fetch users/{uid} and profiles/{uid} (profiles preferred)
      const userSnap = await getDoc(doc(db, 'users', uid));
      const profileSnap = await getDoc(doc(db, 'profiles', uid));

      const userDoc = userSnap.exists() ? userSnap.data() : {};
      const profileDoc = profileSnap.exists() ? profileSnap.data() : {};

      const profile = { ...userDoc, ...profileDoc }; // merge, profile fields override

      // spendingHistory expected: array of maps { date: Timestamp | ISO, amount: number, merchant?, category?, items? }
      const spendingHistoryRaw = profile.spendingHistory || [];
      // normalize into array of { date: Date, amount: number, merchant, category, items }
      const transactions = (spendingHistoryRaw || []).map(tx => {
        const dateVal = tx?.date;
        const date = dateVal ? (dateVal.toDate ? dateVal.toDate() : new Date(dateVal)) : null;
        const amt = parseAmount(tx?.amount ?? tx?.value ?? 0);
        return {
          date,
          amount: amt,
          merchant: tx?.merchant || tx?.place || tx?.vendor || null,
          category: tx?.category || (tx?.items && tx.items[0]?.category) || null,
          items: tx?.items || tx?.description || '',
          raw: tx
        };
      }).filter(t => t.date || t.amount !== undefined);

      // Determine current month key
      const now = new Date();
      const currentMonthKey = `${now.getFullYear()}-${now.getMonth()+1}`;

      // filter transactions for current month
      const thisMonthTx = transactions.filter(t => t.date && toMonthKey(t.date) === currentMonthKey);

      // compute totals
      const totalThisMonth = thisMonthTx.reduce((s,t) => s + (t.amount || 0), 0);
      const tripsCount = Math.max(0, thisMonthTx.length);
      const avgPerTrip = tripsCount ? (totalThisMonth / tripsCount) : 0;

      // monthlyBudget from profile.monthlyBudget (optional)
      const monthlyBudget = profile.monthlyBudget ?? profile.budget ?? null; // expected as number (e.g., 500)
      const pctOfBudget = monthlyBudget ? ( (totalThisMonth / monthlyBudget) * 100 ) : null;
      const savedVal = (monthlyBudget != null) ? (monthlyBudget - totalThisMonth) : null;

      // weekly breakdown: split month into 4 buckets by date
      const weeks = [0,0,0,0,0]; // index 1..4, index 0 unused maybe
      const weekTx = [[],[],[],[],[]];
      for(const t of thisMonthTx){
        if (!t.date) continue;
        const day = t.date.getDate();
        // naive week mapping: days 1-7 -> week1, 8-14 -> week2, 15-21 -> week3, 22-31 -> week4
        let wk = 1;
        if (day >= 8 && day <= 14) wk = 2;
        else if (day >= 15 && day <= 21) wk = 3;
        else if (day >= 22) wk = 4;
        weeks[wk] += t.amount;
        weekTx[wk].push(t);
      }

      // category aggregation
      const categories = {};
      for(const t of thisMonthTx){
        const cat = t.category || 'Mixed';
        categories[cat] = (categories[cat]||0) + (t.amount || 0);
      }

      // recent transactions sorted desc by date (show last 6)
      const recent = transactions.sort((a,b) => {
        const da = a.date ? a.date.getTime() : 0;
        const db = b.date ? b.date.getTime() : 0;
        return db - da;
      }).slice(0,8);

      // --- Update DOM ---
      safeText('totalSpentVal', fmtCurrency(totalThisMonth));
      safeText('cardTotalSpent', fmtCurrency(totalThisMonth));
      safeText('pctOfBudget', monthlyBudget ? (Math.round(pctOfBudget) + '% of $' + monthlyBudget) : 'no budget set');
      safeText('savedVal', savedVal != null ? fmtCurrency(savedVal) : '—');
      safeText('savedNote', monthlyBudget ? `of $${monthlyBudget}` : 'No monthlyBudget set in profile');
      safeText('moneySaved', fmtCurrency((profile.previousMonthTotal ? profile.previousMonthTotal - totalThisMonth : (profile.savedThisMonth || 0)) || 0));
      safeText('avgPerWeek', fmtCurrency((totalThisMonth / 4) || 0));
      safeText('cardTotalSpent', fmtCurrency(totalThisMonth));
      safeText('pctChangeBadge', profile.pctChangeLabel || '-');
      safeText('onTrackBadge', (monthlyBudget && pctOfBudget < 90) ? 'On Track' : 'Check');
      safeText('savedBadge', profile.savedBadge || '-');
      safeText('tripCountBadge', tripsCount ? `${tripsCount} trips` : '0 trips');
      safeText('avgPerTrip', fmtCurrency(avgPerTrip));
      safeText('tripsNote', tripsCount ? `${(tripsCount / (now.getMonth()+1 || 1)).toFixed(1)} trips per week on average` : '—');
      safeText('weeklyBudgetLabel', monthlyBudget ? `Weekly Budget: $${(monthlyBudget/4).toFixed(2)}` : 'Weekly Budget: —');
      safeText('weeklyStatus', (monthlyBudget && pctOfBudget < 100) ? 'Under budget' : (monthlyBudget ? 'Over budget' : '—'));
      safeText('budgetPctText', monthlyBudget ? `${Math.round(pctOfBudget)}% of budget used` : '—');

      // progress bar
      if (monthlyBudget) setBarWidth('budgetProgressBar', pctOfBudget);

      // week bars and badges
      const weekTotals = [0, weeks[1]||0, weeks[2]||0, weeks[3]||0, weeks[4]||0];
      const monthTotal = weekTotals.reduce((a,b)=>a+b,0) || 1; // avoid div by zero
      for(let i=1;i<=4;i++){
        safeText(`week${i}Amount`, fmtCurrency(weekTotals[i]));
        const pct = monthlyBudget ? Math.round((weekTotals[i] / monthlyBudget) * 100) : Math.round((weekTotals[i] / monthTotal) * 100);
        safeText(`week${i}PctBadge`, (monthlyBudget ? `${pct}%` : `${pct}%`));
        setBarWidth(`week${i}Bar`, pct);
      }

      // categories list
      const categoriesListEl = document.getElementById('categoriesList');
      if(categoriesListEl){
        categoriesListEl.innerHTML = '';
        const entries = Object.entries(categories).sort((a,b)=>b[1]-a[1]);
        if(entries.length===0){
          categoriesListEl.innerHTML = '<div class="text-sm muted">No category data yet</div>';
        } else {
          entries.forEach(([cat,val])=>{
            const pct = monthlyBudget ? Math.round((val / monthlyBudget) * 100) : Math.round((val / monthTotal) * 100);
            const row = document.createElement('div');
            row.innerHTML = `
              <div class="flex justify-between text-sm">
                <span>${cat}</span>
                <span>${fmtCurrency(val)} (${pct}%)</span>
              </div>
              <div class="w-full bg-green-200 h-1 rounded mt-1">
                <div class="bg-green-700 h-1 rounded" style="width:${pct}%"></div>
              </div>
            `;
            categoriesListEl.appendChild(row);
          });
        }
      }

      // recent transactions list
      const recentEl = document.getElementById('recentTransactions');
      if(recentEl){
        recentEl.innerHTML = '';
        if(recent.length===0){
          recentEl.innerHTML = '<div class="text-sm muted">No transactions yet</div>';
        } else {
          recent.forEach(tx=>{
            const d = tx.date ? tx.date.toLocaleDateString() : '—';
            const merchant = tx.merchant || (Array.isArray(tx.items) ? (tx.items[0]?.name || '') : '') || 'Unknown';
            const category = tx.category || 'Mixed';
            const amountText = fmtCurrency(tx.amount);
            const row = document.createElement('div');
            row.className = 'flex justify-between items-center p-4 bg-green-50 rounded-2xl';
            row.innerHTML = `
              <div>
                <h4 class="font-medium">${merchant}</h4>
                <p class="text-sm text-green-800/80">${Array.isArray(tx.items) ? tx.items.slice(0,3).map(it=> it.name || it).join(', ') : (tx.items || '')}</p>
                <span class="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded">${category}</span>
                <span class="text-xs text-green-800/60 ml-2">${d}</span>
              </div>
              <p class="text-lg font-semibold">${amountText}</p>
            `;
            recentEl.appendChild(row);
          });
        }
      }

    }); // onAuthStateChanged
   </script>

   <script src="../recipes.js"></script>
  <script src="../scripts.js"></script>
</body>
<footer class="bg-white border-t border-gray-200 py-6">
    <div class="max-w-7xl mx-auto px-6 lg:px-8 text-center text-sm text-gray-500">
      © 2025 Healthly. All rights reserved.
    </div>
  </footer>
</html>
